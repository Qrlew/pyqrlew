import os
import numpy as np
import pandas as pd
from pyqrlew.io import PostgreSQL
from pyqrlew import Dialect, Dataset

# pytest -s tests/test_dataset.py::test_ranges
def test_ranges():
    """Test the consistency of results for queries stored in a file."""
    database = PostgreSQL()
    dataset = database.extract() # load the db        
    new_dataset = dataset.extract.census.age.with_range(20, 42)
    relation = new_dataset.relation('SELECT age FROM extract.census')
    print(relation.schema())
    assert(relation.schema()=='{age: int[20 42]}')

# pytest -s tests/test_dataset.py::test_possible_values
def test_possible_values():
    """Test the consistency of results for queries stored in a file."""
    database = PostgreSQL()
    dataset = database.extract() # load the db        
    new_dataset = dataset.extract.census.workclass.with_possible_values(['Local-gov', 'Private'])
    relation = new_dataset.relation('SELECT workclass FROM extract.census')
    print(relation.schema())
    assert(relation.schema()=='{workclass: str{Local-gov, Private}}')

# pytest -s tests/test_dataset.py::test_constraint
def test_constraint():
    """Test the consistency of results for queries stored in a file."""
    database = PostgreSQL()
    dataset = database.extract() # load the db        
    new_dataset = dataset.extract.census.age.with_unique_constraint()
    relation = new_dataset.relation('SELECT age FROM extract.census')
    print(relation.schema())
    assert(relation.schema()=='{age: int[20 90] (UNIQUE)}')

# pytest -s tests/test_dataset.py::test_relation
def test_relation():
    """Test the consistency of results for queries stored in a file."""
    database = PostgreSQL()
    dataset = database.extract() # load the db        
    relation = dataset.extract.census.relation()
    print(relation.schema())


# pytest -s tests/test_dataset.py::test_from_queries
def test_from_queries():
    """Test the consistency of results for queries stored in a file."""
    database = PostgreSQL()
    dataset = database.extract() # load the db
    queries = [
        (("dataset_name", "my_schema", "boomers",), "SELECT * FROM extract.census WHERE age >= 60"),
        (("dataset_name", "my_schema", "genx",), "SELECT * FROM extract.census WHERE age >= 40 AND age < 60"),
        (("dataset_name", "my_schema", "millenials",), "SELECT * FROM extract.census WHERE age >= 30 AND age < 40"),
        (("dataset_name", "my_schema", "genz",), "SELECT * FROM extract.census WHERE age < 30"),
    ]
    new_ds = dataset.from_queries(queries)
    genx = new_ds.my_schema.genx.relation()
    print(genx.schema())


# pytest -s tests/test_dataset.py::test_from_str_bis
def test_from_str_bis():
    dataset='{"@type": "sarus_data_spec/sarus_data_spec.Dataset", "uuid": "32a28b78e29543729f9aa6530b7fe9ef", "name": "Transformed", "spec": {"transformed": {"transform": "8feff2ec007340348704d908772ef5ff", "arguments": [], "named_arguments": {}}}, "properties": {}, "doc": "This ia a demo dataset for testing purpose"}'
    schema = '{"@type": "sarus_data_spec/sarus_data_spec.Schema", "uuid": "9e7813d17b5644bca143b65f3d118c24", "dataset": "32a28b78e29543729f9aa6530b7fe9ef", "name": "Transformed_schema", "type": {"name": "transformed_schema", "struct": {"fields": [{"name": "sarus_data", "type": {"name": "Union", "union": {"fields": [{"name": "st51_cwyuajpk", "type": {"name": "Union", "union": {"fields": [{"name": "vaymkrql", "type": {"name": "Struct", "struct": {"fields": [{"name": "id", "type": {"name": "Integer", "integer": {"base": "INT64", "min": "-9223372036854775808", "max": "9223372036854775807", "possible_values": []}, "properties": {}}}, {"name": "text", "type": {"name": "Text UTF-8", "text": {"encoding": "UTF-8", "min": null, "max": null, "possible_values": []}, "properties": {}}}]}, "properties": {}}}, {"name": "oasezpii", "type": {"name": "Struct", "struct": {"fields": [{"name": "id", "type": {"name": "Integer", "integer": {"base": "INT64", "min": "-9223372036854775808", "max": "9223372036854775807", "possible_values": []}, "properties": {}}}, {"name": "integer", "type": {"name": "Integer", "integer": {"base": "INT64", "min": "-9223372036854775808", "max": "9223372036854775807", "possible_values": []}, "properties": {}}}, {"name": "float", "type": {"name": "Float64", "float": {"base": "FLOAT64", "min": "-1125899906842624", "max": "1125899906842624", "possible_values": []}, "properties": {}}}, {"name": "datetime", "type": {"name": "Datetime", "datetime": {"format": "%Y-%m-%d %H:%M:%S", "min": "01-01-01 00:00:00", "max": "9999-12-31 00:00:00"}, "properties": {}}}, {"name": "date", "type": {"name": "Datetime", "datetime": {"format": "%Y-%m-%d %H:%M:%S", "min": "01-01-01 00:00:00", "max": "9999-12-31 00:00:00"}, "properties": {}}}, {"name": "boolean", "type": {"name": "Boolean", "boolean": {}, "properties": {}}}, {"name": "text", "type": {"name": "Text UTF-8", "text": {"encoding": "UTF-8", "min": null, "max": null, "possible_values": []}, "properties": {}}}, {"name": "public_fk", "type": {"name": "Integer", "integer": {"base": "INT64", "min": "-9223372036854775808", "max": "9223372036854775807", "possible_values": []}, "properties": {}}}, {"name": "sarus_is_public", "type": {"name": "Boolean", "boolean": {}, "properties": {}}}, {"name": "sarus_privacy_unit", "type": {"name": "Text UTF-8", "text": {"encoding": "UTF-8", "min": null, "max": null, "possible_values": []}, "properties": {}}}, {"name": "sarus_weights", "type": {"name": "Float64", "float": {"base": "FLOAT64", "min": "-1125899906842624", "max": "1125899906842624", "possible_values": []}, "properties": {}}}]}, "properties": {}}}, {"name": "rsawqlwy", "type": {"name": "Struct", "struct": {"fields": [{"name": "id", "type": {"name": "Integer", "integer": {"base": "INT64", "min": "-9223372036854775808", "max": "9223372036854775807", "possible_values": []}, "properties": {}}}, {"name": "integer", "type": {"name": "Integer", "integer": {"base": "INT64", "min": "-9223372036854775808", "max": "9223372036854775807", "possible_values": []}, "properties": {}}}, {"name": "float", "type": {"name": "Float64", "float": {"base": "FLOAT64", "min": "-1125899906842624", "max": "1125899906842624", "possible_values": []}, "properties": {}}}, {"name": "datetime", "type": {"name": "Datetime", "datetime": {"format": "%Y-%m-%d %H:%M:%S", "min": "01-01-01 00:00:00", "max": "9999-12-31 00:00:00"}, "properties": {}}}, {"name": "date", "type": {"name": "Datetime", "datetime": {"format": "%Y-%m-%d %H:%M:%S", "min": "01-01-01 00:00:00", "max": "9999-12-31 00:00:00"}, "properties": {}}}, {"name": "boolean", "type": {"name": "Boolean", "boolean": {}, "properties": {}}}, {"name": "text", "type": {"name": "Text UTF-8", "text": {"encoding": "UTF-8", "min": null, "max": null, "possible_values": []}, "properties": {}}}, {"name": "public_fk", "type": {"name": "Integer", "integer": {"base": "INT64", "min": "-9223372036854775808", "max": "9223372036854775807", "possible_values": []}, "properties": {}}}, {"name": "sarus_is_public", "type": {"name": "Boolean", "boolean": {}, "properties": {}}}, {"name": "sarus_privacy_unit", "type": {"name": "Text UTF-8", "text": {"encoding": "UTF-8", "min": null, "max": null, "possible_values": []}, "properties": {}}}, {"name": "sarus_weights", "type": {"name": "Float64", "float": {"base": "FLOAT64", "min": "-1125899906842624", "max": "1125899906842624", "possible_values": []}, "properties": {}}}]}, "properties": {}}}, {"name": "agjtmkwt", "type": {"name": "Struct", "struct": {"fields": [{"name": "id", "type": {"name": "Integer", "integer": {"base": "INT64", "min": "-9223372036854775808", "max": "9223372036854775807", "possible_values": []}, "properties": {}}}, {"name": "text", "type": {"name": "Text UTF-8", "text": {"encoding": "UTF-8", "min": null, "max": null, "possible_values": []}, "properties": {}}}, {"name": "sarus_is_public", "type": {"name": "Boolean", "boolean": {}, "properties": {}}}, {"name": "sarus_privacy_unit", "type": {"name": "Text UTF-8", "text": {"encoding": "UTF-8", "min": null, "max": null, "possible_values": []}, "properties": {}}}, {"name": "sarus_weights", "type": {"name": "Float64", "float": {"base": "FLOAT64", "min": "-1125899906842624", "max": "1125899906842624", "possible_values": []}, "properties": {}}}]}, "properties": {}}}]}, "properties": {"public_fields": "[]"}}}]}, "properties": {"public_fields": "[]"}}}, {"name": "sarus_weights", "type": {"name": "Integer", "integer": {"min": "-9223372036854775808", "max": "9223372036854775807", "base": "INT64", "possible_values": []}, "properties": {}}}, {"name": "sarus_is_public", "type": {"name": "Boolean", "boolean": {}, "properties": {}}}, {"name": "sarus_privacy_unit", "type": {"name": "Id", "id": {"base": "STRING", "unique": false}, "properties": {}}}]}, "properties": {}}, "protected": {"label": "data", "paths": [], "properties": {}}, "properties": {"max_max_multiplicity": "1", "foreign_keys": "", "primary_keys": ""}}'
    size = '{"@type": "sarus_data_spec/sarus_data_spec.Size", "uuid": "9796c71645f4403581404252c73c055d", "dataset": "32a28b78e29543729f9aa6530b7fe9ef", "name": "Transformed_schema_sizes", "statistics": {"name": "Union", "union": {"fields": [{"name": "st51_cwyuajpk", "statistics": {"name": "Union", "union": {"fields": [{"name": "vaymkrql", "statistics": {"name": "Struct", "struct": {"fields": [{"name": "id", "statistics": {"integer": {"distribution": {"integer": {"max": "9223372036854775807", "min": "-9223372036854775808", "points": []}, "properties": {}}, "multiplicity": 1.0, "size": 3}, "name": "Integer", "properties": {}}}, {"name": "text", "statistics": {"text": {"distribution": {"integer": {"max": "9223372036854775807", "min": "-9223372036854775808", "points": []}, "properties": {}}, "multiplicity": 1.0, "size": 3}, "name": "Text", "properties": {}}}, {"name": "sarus_is_public", "statistics": {"boolean": {"distribution": {"integer": {"max": "9223372036854775807", "min": "-9223372036854775808", "points": []}, "properties": {}}, "multiplicity": 1.0, "size": 3}, "name": "Boolean", "properties": {}}}, {"name": "sarus_privacy_unit", "statistics": {"text": {"distribution": {"integer": {"max": "9223372036854775807", "min": "-9223372036854775808", "points": []}, "properties": {}}, "multiplicity": 1.0, "size": 3}, "name": "Text", "properties": {}}}, {"name": "sarus_weights", "statistics": {"float": {"distribution": {"double": {"max": "1125899906842624", "min": "-1125899906842624", "points": []}, "properties": {}}, "multiplicity": 1.0, "size": 3}, "name": "Float", "properties": {}}}], "size": "3", "multiplicity": 1.0}, "properties": {}}}, {"name": "oasezpii", "statistics": {"name": "Struct", "struct": {"fields": [{"name": "id", "statistics": {"integer": {"distribution": {"integer": {"max": "9223372036854775807", "min": "-9223372036854775808", "points": []}, "properties": {}}, "multiplicity": 1.0, "size": 900}, "name": "Integer", "properties": {}}}, {"name": "integer", "statistics": {"integer": {"distribution": {"integer": {"max": "9223372036854775807", "min": "-9223372036854775808", "points": []}, "properties": {}}, "multiplicity": 1.0, "size": 900}, "name": "Integer", "properties": {}}}, {"name": "float", "statistics": {"float": {"distribution": {"double": {"max": "1125899906842624", "min": "-1125899906842624", "points": []}, "properties": {}}, "multiplicity": 1.0, "size": 900}, "name": "Float", "properties": {}}}, {"name": "datetime", "statistics": {"datetime": {"distribution": {"integer": {"max": "9223372036854775807", "min": "-9223372036854775808", "points": []}, "properties": {}}, "multiplicity": 1.0, "size": 900}, "name": "Datetime", "properties": {}}}, {"name": "date", "statistics": {"datetime": {"distribution": {"integer": {"max": "9223372036854775807", "min": "-9223372036854775808", "points": []}, "properties": {}}, "multiplicity": 1.0, "size": 900}, "name": "Datetime", "properties": {}}}, {"name": "boolean", "statistics": {"boolean": {"distribution": {"integer": {"max": "9223372036854775807", "min": "-9223372036854775808", "points": []}, "properties": {}}, "multiplicity": 1.0, "size": 900}, "name": "Boolean", "properties": {}}}, {"name": "text", "statistics": {"text": {"distribution": {"integer": {"max": "9223372036854775807", "min": "-9223372036854775808", "points": []}, "properties": {}}, "multiplicity": 1.0, "size": 900}, "name": "Text", "properties": {}}}, {"name": "public_fk", "statistics": {"integer": {"distribution": {"integer": {"max": "9223372036854775807", "min": "-9223372036854775808", "points": []}, "properties": {}}, "multiplicity": 1.0, "size": 900}, "name": "Integer", "properties": {}}}, {"name": "sarus_is_public", "statistics": {"boolean": {"distribution": {"integer": {"max": "9223372036854775807", "min": "-9223372036854775808", "points": []}, "properties": {}}, "multiplicity": 1.0, "size": 900}, "name": "Boolean", "properties": {}}}, {"name": "sarus_privacy_unit", "statistics": {"text": {"distribution": {"integer": {"max": "9223372036854775807", "min": "-9223372036854775808", "points": []}, "properties": {}}, "multiplicity": 1.0, "size": 900}, "name": "Text", "properties": {}}}, {"name": "sarus_weights", "statistics": {"float": {"distribution": {"double": {"max": "1125899906842624", "min": "-1125899906842624", "points": []}, "properties": {}}, "multiplicity": 1.0, "size": 900}, "name": "Float", "properties": {}}}], "size": "900", "multiplicity": 1.0}, "properties": {}}}, {"name": "rsawqlwy", "statistics": {"name": "Struct", "struct": {"fields": [{"name": "id", "statistics": {"integer": {"distribution": {"integer": {"max": "9223372036854775807", "min": "-9223372036854775808", "points": []}, "properties": {}}, "multiplicity": 1.0, "size": 900}, "name": "Integer", "properties": {}}}, {"name": "integer", "statistics": {"integer": {"distribution": {"integer": {"max": "9223372036854775807", "min": "-9223372036854775808", "points": []}, "properties": {}}, "multiplicity": 1.0, "size": 900}, "name": "Integer", "properties": {}}}, {"name": "float", "statistics": {"float": {"distribution": {"double": {"max": "1125899906842624", "min": "-1125899906842624", "points": []}, "properties": {}}, "multiplicity": 1.0, "size": 900}, "name": "Float", "properties": {}}}, {"name": "datetime", "statistics": {"datetime": {"distribution": {"integer": {"max": "9223372036854775807", "min": "-9223372036854775808", "points": []}, "properties": {}}, "multiplicity": 1.0, "size": 900}, "name": "Datetime", "properties": {}}}, {"name": "date", "statistics": {"datetime": {"distribution": {"integer": {"max": "9223372036854775807", "min": "-9223372036854775808", "points": []}, "properties": {}}, "multiplicity": 1.0, "size": 900}, "name": "Datetime", "properties": {}}}, {"name": "boolean", "statistics": {"boolean": {"distribution": {"integer": {"max": "9223372036854775807", "min": "-9223372036854775808", "points": []}, "properties": {}}, "multiplicity": 1.0, "size": 900}, "name": "Boolean", "properties": {}}}, {"name": "text", "statistics": {"text": {"distribution": {"integer": {"max": "9223372036854775807", "min": "-9223372036854775808", "points": []}, "properties": {}}, "multiplicity": 1.0, "size": 900}, "name": "Text", "properties": {}}}, {"name": "public_fk", "statistics": {"integer": {"distribution": {"integer": {"max": "9223372036854775807", "min": "-9223372036854775808", "points": []}, "properties": {}}, "multiplicity": 1.0, "size": 900}, "name": "Integer", "properties": {}}}, {"name": "sarus_is_public", "statistics": {"boolean": {"distribution": {"integer": {"max": "9223372036854775807", "min": "-9223372036854775808", "points": []}, "properties": {}}, "multiplicity": 1.0, "size": 900}, "name": "Boolean", "properties": {}}}, {"name": "sarus_privacy_unit", "statistics": {"text": {"distribution": {"integer": {"max": "9223372036854775807", "min": "-9223372036854775808", "points": []}, "properties": {}}, "multiplicity": 1.0, "size": 900}, "name": "Text", "properties": {}}}, {"name": "sarus_weights", "statistics": {"float": {"distribution": {"double": {"max": "1125899906842624", "min": "-1125899906842624", "points": []}, "properties": {}}, "multiplicity": 1.0, "size": 900}, "name": "Float", "properties": {}}}], "size": "900", "multiplicity": 1.0}, "properties": {}}}, {"name": "agjtmkwt", "statistics": {"name": "Struct", "struct": {"fields": [{"name": "id", "statistics": {"integer": {"distribution": {"integer": {"max": "9223372036854775807", "min": "-9223372036854775808", "points": []}, "properties": {}}, "multiplicity": 1.0, "size": 3}, "name": "Integer", "properties": {}}}, {"name": "text", "statistics": {"text": {"distribution": {"integer": {"max": "9223372036854775807", "min": "-9223372036854775808", "points": []}, "properties": {}}, "multiplicity": 1.0, "size": 3}, "name": "Text", "properties": {}}}, {"name": "sarus_is_public", "statistics": {"boolean": {"distribution": {"integer": {"max": "9223372036854775807", "min": "-9223372036854775808", "points": []}, "properties": {}}, "multiplicity": 1.0, "size": 3}, "name": "Boolean", "properties": {}}}, {"name": "sarus_privacy_unit", "statistics": {"text": {"distribution": {"integer": {"max": "9223372036854775807", "min": "-9223372036854775808", "points": []}, "properties": {}}, "multiplicity": 1.0, "size": 3}, "name": "Text", "properties": {}}}, {"name": "sarus_weights", "statistics": {"float": {"distribution": {"double": {"max": "1125899906842624", "min": "-1125899906842624", "points": []}, "properties": {}}, "multiplicity": 1.0, "size": 3}, "name": "Float", "properties": {}}}], "size": "3", "multiplicity": 1.0}, "properties": {}}}]}, "properties": {}}, "properties": {}}]}, "properties": {}}, "properties": {}}'

    ds = Dataset.from_str(dataset, schema, size)

    print(ds.relations())